<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body {
      margin: 0;
      background: #222;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    canvas {
      width: 100%;
      height: auto;
      max-width: 600px;
      border: 2px solid #0f0;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <canvas id="gridCanvas" width="600" height="800"></canvas>

  <!-- Helper de Twitch Extensions -->
  <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>

  <script>
    (function() {
      // Configuración de la cuadrícula (igual que en el juego)
      const GRID_COLS = 26; // A-Z
      const GRID_ROWS = 33; // 1-33
      const canvas = document.getElementById('gridCanvas');
      const ctx = canvas.getContext('2d');

      // Dibuja la cuadrícula (copia del estilo del juego)
      function drawGrid() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#0f0';
        ctx.lineWidth = 1;

        const cellW = canvas.width / GRID_COLS;
        const cellH = canvas.height / GRID_ROWS;

        // Líneas verticales
        for (let c = 0; c <= GRID_COLS; c++) {
          ctx.beginPath();
          ctx.moveTo(c * cellW, 0);
          ctx.lineTo(c * cellW, canvas.height);
          ctx.stroke();
        }

        // Líneas horizontales
        for (let r = 0; r <= GRID_ROWS; r++) {
          ctx.beginPath();
          ctx.moveTo(0, r * cellH);
          ctx.lineTo(canvas.width, r * cellH);
          ctx.stroke();
        }

        // Letras (A-Z) en la parte superior
        ctx.fillStyle = '#0f0';
        ctx.font = 'bold 12px monospace';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        for (let c = 0; c < GRID_COLS; c++) {
          ctx.fillText(String.fromCharCode(65 + c), c * cellW + cellW/2, 4);
        }

        // Números (1-33) en el borde izquierdo
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        for (let r = 0; r < GRID_ROWS; r++) {
          ctx.fillText(r + 1, cellW - 6, r * cellH + cellH/2);
        }
      }

      drawGrid();

      // Variables para almacenar datos del viewer y del canal
      let channelId = null;
      let chatToken = null;
      let viewerId = null;
      // Reemplaza con tu Client ID real
      const CLIENT_ID = 'p044zcurd8w9vn2fjcd5fw13o7o205'; // <-- YA ESTÁ TU CLIENT ID

      // --- LOGS DE DEPURACIÓN ---
      console.log('Inicializando extensión...');

      // Escuchar el evento de autorización de Twitch
      Twitch.ext.onAuthorized((auth) => {
        channelId = auth.channelId;
        console.log('onAuthorized - channelId:', channelId);
        console.log('onAuthorized - token (opaco):', auth.token ? 'recibido' : 'no recibido');
      });

      // El objeto viewer proporciona el token con los scopes solicitados
      Twitch.ext.viewer.on('authorized', () => {
        chatToken = Twitch.ext.viewer.helixToken;
        viewerId = Twitch.ext.viewer.id;
        console.log('viewer.onAuthorized - chatToken:', chatToken ? 'obtenido' : 'NO obtenido');
        console.log('viewer.onAuthorized - viewerId:', viewerId);
      });

      // Función para enviar mensaje al chat usando la API de Twitch
      async function sendChatMessage(message) {
        console.log('sendChatMessage llamado con:', message);
        console.log('Estado actual - channelId:', channelId, 'chatToken:', chatToken ? 'sí' : 'no', 'viewerId:', viewerId, 'CLIENT_ID:', CLIENT_ID);

        if (!channelId || !chatToken || !viewerId) {
          console.error('Faltan datos para enviar mensaje');
          alert('La extensión no está completamente autorizada. Por favor, recarga la página.');
          return;
        }

        const url = 'https://api.twitch.tv/helix/chat/messages';
        const body = {
          broadcaster_id: channelId,
          sender_id: viewerId,
          message: message
        };

        console.log('Enviando fetch a:', url, 'con body:', body);

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${chatToken}`,
              'Client-Id': CLIENT_ID,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          });

          console.log('Respuesta recibida, status:', response.status);

          if (!response.ok) {
            const errorText = await response.text();
            console.error('Error al enviar mensaje:', response.status, errorText);
            alert('Error al enviar el comando. Código: ' + response.status);
          } else {
            console.log('Comando enviado al chat correctamente:', message);
            // Opcional: feedback visual breve
            canvas.style.borderColor = '#ff0';
            setTimeout(() => canvas.style.borderColor = '#0f0', 200);
          }
        } catch (error) {
          console.error('Error de red en fetch:', error);
        }
      }

      // Manejador de clics en el canvas
      canvas.addEventListener('click', async (e) => {
        console.log('Click detectado en canvas');
        // Calcular en qué celda se hizo clic
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;

        const mouseX = (e.clientX - rect.left) * scaleX;
        const mouseY = (e.clientY - rect.top) * scaleY;

        const col = Math.floor(mouseX / (canvas.width / GRID_COLS));
        const row = Math.floor(mouseY / (canvas.height / GRID_ROWS));

        console.log('Coordenadas:', { mouseX, mouseY, col, row });

        if (col >= 0 && col < GRID_COLS && row >= 0 && row < GRID_ROWS) {
          // Convertir a comando: col 0 -> 'a', row 0 -> '1'
          const letter = String.fromCharCode(97 + col); // 'a' para col 0
          const number = row + 1;
          const command = `!${letter}${number}`; // ej: !a12

          console.log('Clic en celda válida:', letter, number, 'comando:', command);
          await sendChatMessage(command);
        } else {
          console.log('Clic fuera de la cuadrícula');
        }
      });

      // Redibujar si la ventana cambia de tamaño (opcional)
      window.addEventListener('resize', drawGrid);

      // --- PRUEBA AUTOMÁTICA (opcional, comentar si no se desea) ---
      // setTimeout(() => {
      //   console.log('Enviando mensaje de prueba automático...');
      //   sendChatMessage('!prueba desde extensión');
      // }, 10000);

    })();
  </script>
</body>
</html>
